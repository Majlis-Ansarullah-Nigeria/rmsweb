@page "/report-submission"
@using MudBlazor
@using System.Collections.Generic
@using System.Linq

@inject IStringLocalizer<ReportSubmission> L

@if (!_loaded)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else
{
    <MudTabs Elevation="25" Rounded="true" Centered="true" ApplyEffectsToContainer="true" AlwaysShowScrollButtons="true">
        @foreach (var section in Report.Sections)
        {
            var allQuestionsInSection = section.Questions.ToList();
            var title = section.Title;
            var answeredQuestionsCount = section.Questions.Count(q => IsQuestionAnswered(q));
            var badgeColor = answeredQuestionsCount == allQuestionsInSection.Count ? Color.Success : Color.Error;

            <MudTabPanel Text="@title" BadgeData="@($"{answeredQuestionsCount}/{allQuestionsInSection.Count}")" BadgeColor="@badgeColor">
                <div class="mt-3">
                    @foreach (var question in section.Questions)
                    {
                        <div class="mb-3">
                            <span class="font-weight-bold">@question.Question</span>
                            <div class="mt-2">
                                @switch (question.InputType)
                                {
                                    case QuestionInputType.Checkbox:
                                        <MudCheckBox @bind-Checked="@question.AnswerCheckbox" Label="@L["Yes"]" Color="Color.Primary" />
                                        break;
                                    case QuestionInputType.Integer:
                                        <MudNumericField T="int?" @bind-Value="@question.AnswerInteger" Label="@question.InputLabel" />
                                        break;
                                    case QuestionInputType.Dropdown:
                                        <MudSelect @bind-Value="@question.Answer" Label="@question.InputLabel">
                                            @foreach (var option in question.DropdownOptions)
                                            {
                                                <MudOption Value="@option" Label="@option" />
                                            }
                                        </MudSelect>
                                        break;
                                   @* case QuestionInputType.Radio:
                                        <div class="d-flex flex-wrap">
                                            @foreach (var option in question.DropdownOptions)
                                            {
                                                <div class="mr-3">
                                                    <MudRadio Group="@question.RadioGroup" Value="@option" Label="@option" />
                                                </div>
                                            }
                                        </div>
                                        break;*@
                                    case QuestionInputType.Date:
                                        <MudDatePicker @bind-Date="@question.AnswerDateTime" Label="@question.InputLabel" />
                                        break;
                                    case QuestionInputType.File:
                                        <MudFileInput Label="@question.InputLabel" OnChange="HandleFileUpload" />
                                        break;
                                    case QuestionInputType.TextInput:
                                    default:
                                        <MudTextField @bind-Value="@question.Answer" FullWidth="true" />
                                        break;
                                }
                            </div>
                        </div>
                    }
                </div>
                <div class="text-right mt-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="() => SaveSection(section)">
                        @L["Save"]
                    </MudButton>
                </div>
            </MudTabPanel>
        }
    </MudTabs>
    <div class="text-right mt-3">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveReport">
            @L["Submit"]
        </MudButton>
    </div>
}

@code {
    private ReportModel Report { get; set; }
    private bool _loaded = false;

    protected override async Task OnInitializedAsync()
    {
        await GenerateMockDataAsync();
        _loaded = true;
    }

    private async Task GenerateMockDataAsync()
    {
        await Task.Delay(1000); // Simulating delay for data retrieval

        Report = new ReportModel
        {
            Sections = new List<Sections>
            {
                new Sections
                {
                    Title = "Section 1",
                    Questions = new List<ReportSectionQuestion>
                    {
                        new ReportSectionQuestion { Question = "What is your educational background?", Answer = "", InputType = QuestionInputType.TextInput },
                        new ReportSectionQuestion { Question = "Do you have a valid driver's license?", AnswerCheckbox = false, InputType = QuestionInputType.Checkbox },
                        new ReportSectionQuestion { Question = "How many years of experience do you have?", AnswerInteger = null, InputType = QuestionInputType.Integer, InputLabel = "Years of Experience" }
                    }
                },
                new Sections
                {
                    Title = "Section 2",
                    Questions = new List<ReportSectionQuestion>
                    {
                        new ReportSectionQuestion { Question = "Are you proficient in any programming languages?", AnswerCheckbox = false, InputType = QuestionInputType.Checkbox },
                        new ReportSectionQuestion { Question = "Please list the programming languages you are proficient in.", Answer = "", InputType = QuestionInputType.TextInput },
                        new ReportSectionQuestion { Question = "What is your expected salary?", AnswerInteger = null, InputType = QuestionInputType.Integer, InputLabel = "Expected Salary" }
                    }
                },
                new Sections
                {
                    Title = "Section 3",
                    Questions = new List<ReportSectionQuestion>
                    {
                        new ReportSectionQuestion { Question = "Select your preferred programming language:", Answer = "", InputType = QuestionInputType.Dropdown, DropdownOptions = new List<string> { "C#", "Java", "Python", "JavaScript" } },
                        new ReportSectionQuestion { Question = "What is your date of birth?", AnswerDateTime = null, InputType = QuestionInputType.Date, InputLabel = "Date of Birth" },
                        new ReportSectionQuestion { Question = "Are you familiar with version control systems?", AnswerCheckbox = false, InputType = QuestionInputType.Checkbox },
                        new ReportSectionQuestion { Question = "Select your gender:", Answer = "", InputType = QuestionInputType.Radio, RadioGroup = "gender", DropdownOptions = new List<string> { "Male", "Female", "Other" } },
                        new ReportSectionQuestion { Question = "Upload your resume:", Answer = "", InputType = QuestionInputType.File, InputLabel = "Resume" }
                    }
                },
                // Add more sections here
            }
        };
    }

    public class ReportModel
    {
        public List<Sections> Sections { get; set; }
    }

    public class Sections
    {
        public string Title { get; set; }
        public List<ReportSectionQuestion> Questions { get; set; }
    }

    public class ReportSectionQuestion
    {
        public string Question { get; set; }
        public string Answer { get; set; }
        public bool AnswerCheckbox { get; set; }
        public int? AnswerInteger { get; set; }
        public DateTime? AnswerDateTime { get; set; }
        public QuestionInputType InputType { get; set; }
        public string InputLabel { get; set; }
        public List<string> DropdownOptions { get; set; }
        public string RadioGroup { get; set; }
    }

    public enum QuestionInputType
    {
        TextInput,
        Checkbox,
        Integer,
        Dropdown,
        Radio,
        Date,
        File
    }

    private void SaveSection(Sections section)
    {
        // Perform save operation for the specific section
        // You can access the questions and answers using section.Questions
        // Example: section.Questions[0].Answer
    }

    private void SaveReport()
    {
        // Perform save operation for the entire report
        // You can access the sections, questions, and answers using Report.Sections
        // Example: Report.Sections[0].Questions[0].Answer
    }

    private bool IsQuestionAnswered(ReportSectionQuestion question)
    {
        switch (question.InputType)
        {
            case QuestionInputType.Checkbox:
                return true; // Checkbox type always considered answered
            case QuestionInputType.Integer:
                return question.AnswerInteger.HasValue;
            default:
                return !string.IsNullOrWhiteSpace(question.Answer);
        }
    }

    private void HandleFileUpload(/*IMudFileUploadEntry[] files*/)
    {
        // Handle file upload logic here
    }
}
